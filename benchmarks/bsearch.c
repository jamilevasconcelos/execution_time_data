/* MDH WCET BENCHMARK SUITE. File version $Id: bs.c 7800 2018-01-19 12:43:12Z lkg02 $ */

/*************************************************************************/
/*                                                                       */
/*   SNU-RT Benchmark Suite for Worst Case Timing Analysis               */
/*   =====================================================               */
/*                              Collected and Modified by S.-S. Lim      */
/*                                           sslim@archi.snu.ac.kr       */
/*                                         Real-Time Research Group      */
/*                                        Seoul National University      */
/*                                                                       */
/*                                                                       */
/*        < Features > - restrictions for our experimental environment   */
/*                                                                       */
/*          1. Completely structured.                                    */
/*               - There are no unconditional jumps.                     */
/*               - There are no exit from loop bodies.                   */
/*                 (There are no 'break' or 'return' in loop bodies)     */
/*          2. No 'switch' statements.                                   */
/*          3. No 'do..while' statements.                                */
/*          4. Expressions are restricted.                               */
/*               - There are no multiple expressions joined by 'or',     */
/*                'and' operations.                                      */
/*          5. No library calls.                                         */
/*               - All the functions needed are implemented in the       */
/*                 source file.                                          */
/*                                                                       */
/*                                                                       */
/*************************************************************************/
/*                                                                       */
/*  FILE: bs.c                                                           */
/*  SOURCE : Public Domain Code                                          */
/*                                                                       */
/*  DESCRIPTION :                                                        */
/*                                                                       */
/*     Binary search for the array of 15 integer elements.               */
/*                                                                       */
/*  REMARK :                                                             */
/*                                                                       */
/*  EXECUTION TIME :                                                     */
/*                                                                       */
/*                                                                       */
/*************************************************************************/
/* Changes:
 * JG 2005/12/12: Prototypes added, printf removed, and changed exit to return in main.
 */
#define _GNU_SOURCE
#include <sched.h>
#include <sys/wait.h>
#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/syscall.h>
#include <string.h>
#include <sys/ioctl.h>
#include <linux/perf_event.h>
#include <linux/hw_breakpoint.h>
#include <asm/unistd.h>
#include <errno.h>
#include <stdint.h>
#include <inttypes.h>
#include <time.h>


//#define DEBUG

struct DATA {
  int  key;
  int  value;
};

//#ifdef DEBUG
//	int cnt1;
//#endif

// Worstcase define como valor a ser buscado um número acima de 1000, além dos dados definidos. Nesse caso, o vetor é completamente varrido até o final. Se não definir WORSTCASE (comentar), o sistema busca um valor entre 0 e 1000.
// #define WORSTCASE


struct DATA data[1000] = {{0, 121}, {1, 173}, {2, 555}, {3, 553}, {4, 456}, {5, 69}, {6, 924}, {7, 494}, {8, 585}, {9, 590}, {10, 135}, {11, 150}, {12, 688}, {13, 422}, {14, 186}, {15, 383}, {16, 839}, {17, 114}, {18, 559}, {19, 915}, {20, 472}, {21, 922}, {22, 360}, {23, 352}, {24, 312}, {25, 489}, {26, 680}, {27, 825}, {28, 800}, {29, 796}, {30, 665}, {31, 845}, {32, 523}, {33, 122}, {34, 332}, {35, 168}, {36, 337}, {37, 553}, {38, 121}, {39, 487}, {40, 449}, {41, 790}, {42, 806}, {43, 175}, {44, 81}, {45, 142}, {46, 939}, {47, 564}, {48, 656}, {49, 873}, {50, 423}, {51, 209}, {52, 743}, {53, 464}, {54, 354}, {55, 696}, {56, 430}, {57, 957}, {58, 607}, {59, 445}, {60, 986}, {61, 978}, {62, 883}, {63, 513}, {64, 183}, {65, 191}, {66, 519}, {67, 134}, {68, 261}, {69, 640}, {70, 690}, {71, 145}, {72, 602}, {73, 680}, {74, 632}, {75, 407}, {76, 30}, {77, 70}, {78, 58}, {79, 65}, {80, 618}, {81, 304}, {82, 479}, {83, 75}, {84, 197}, {85, 550}, {86, 797}, {87, 978}, {88, 876}, {89, 594}, {90, 282}, {91, 195}, {92, 786}, {93, 155}, {94, 464}, {95, 730}, {96, 665}, {97, 568}, {98, 145}, {99, 320}, {100, 583}, {101, 493}, {102, 231}, {103, 61}, {104, 191}, {105, 322}, {106, 898}, {107, 615}, {108, 712}, {109, 193}, {110, 218}, {111, 123}, {112, 914}, {113, 829}, {114, 570}, {115, 373}, {116, 298}, {117, 944}, {118, 423}, {119, 887}, {120, 587}, {121, 187}, {122, 688}, {123, 661}, {124, 761}, {125, 372}, {126, 795}, {127, 894}, {128, 209}, {129, 54}, {130, 259}, {131, 55}, {132, 588}, {133, 430}, {134, 533}, {135, 817}, {136, 932}, {137, 180}, {138, 66}, {139, 185}, {140, 790}, {141, 962}, {142, 375}, {143, 642}, {144, 337}, {145, 126}, {146, 321}, {147, 114}, {148, 132}, {149, 363}, {150, 904}, {151, 743}, {152, 143}, {153, 110}, {154, 881}, {155, 867}, {156, 897}, {157, 73}, {158, 779}, {159, 146}, {160, 640}, {161, 857}, {162, 979}, {163, 485}, {164, 242}, {165, 854}, {166, 675}, {167, 357}, {168, 799}, {169, 914}, {170, 484}, {171, 807}, {172, 550}, {173, 288}, {174, 395}, {175, 247}, {176, 708}, {177, 200}, {178, 882}, {179, 780}, {180, 276}, {181, 109}, {182, 344}, {183, 929}, {184, 350}, {185, 402}, {186, 313}, {187, 35}, {188, 205}, {189, 399}, {190, 518}, {191, 831}, {192, 232}, {193, 249}, {194, 726}, {195, 112}, {196, 38}, {197, 208}, {198, 778}, {199, 76}, {200, 417}, {201, 284}, {202, 761}, {203, 362}, {204, 453}, {205, 54}, {206, 440}, {207, 372}, {208, 689}, {209, 521}, {210, 86}, {211, 460}, {212, 968}, {213, 790}, {214, 945}, {215, 580}, {216, 561}, {217, 753}, {218, 413}, {219, 198}, {220, 596}, {221, 782}, {222, 802}, {223, 466}, {224, 21}, {225, 427}, {226, 865}, {227, 664}, {228, 350}, {229, 286}, {230, 319}, {231, 845}, {232, 184}, {233, 928}, {234, 370}, {235, 33}, {236, 564}, {237, 86}, {238, 675}, {239, 994}, {240, 573}, {241, 971}, {242, 316}, {243, 484}, {244, 633}, {245, 843}, {246, 581}, {247, 713}, {248, 566}, {249, 83}, {250, 266}, {251, 898}, {252, 327}, {253, 240}, {254, 272}, {255, 65}, {256, 517}, {257, 156}, {258, 862}, {259, 736}, {260, 738}, {261, 678}, {262, 717}, {263, 142}, {264, 361}, {265, 583}, {266, 73}, {267, 575}, {268, 318}, {269, 279}, {270, 762}, {271, 732}, {272, 934}, {273, 455}, {274, 463}, {275, 262}, {276, 729}, {277, 207}, {278, 770}, {279, 673}, {280, 888}, {281, 848}, {282, 591}, {283, 684}, {284, 38}, {285, 615}, {286, 374}, {287, 783}, {288, 941}, {289, 918}, {290, 868}, {291, 359}, {292, 135}, {293, 645}, {294, 619}, {295, 111}, {296, 79}, {297, 817}, {298, 472}, {299, 814}, {300, 821}, {301, 399}, {302, 973}, {303, 834}, {304, 797}, {305, 579}, {306, 622}, {307, 354}, {308, 449}, {309, 663}, {310, 281}, {311, 294}, {312, 223}, {313, 179}, {314, 481}, {315, 414}, {316, 616}, {317, 113}, {318, 252}, {319, 226}, {320, 263}, {321, 843}, {322, 909}, {323, 360}, {324, 94}, {325, 620}, {326, 541}, {327, 340}, {328, 862}, {329, 609}, {330, 272}, {331, 333}, {332, 956}, {333, 309}, {334, 389}, {335, 241}, {336, 952}, {337, 156}, {338, 919}, {339, 641}, {340, 793}, {341, 392}, {342, 629}, {343, 634}, {344, 786}, {345, 593}, {346, 398}, {347, 64}, {348, 275}, {349, 611}, {350, 84}, {351, 341}, {352, 315}, {353, 287}, {354, 471}, {355, 449}, {356, 342}, {357, 620}, {358, 407}, {359, 18}, {360, 238}, {361, 254}, {362, 467}, {363, 477}, {364, 337}, {365, 113}, {366, 930}, {367, 660}, {368, 802}, {369, 249}, {370, 628}, {371, 557}, {372, 338}, {373, 426}, {374, 967}, {375, 594}, {376, 328}, {377, 981}, {378, 310}, {379, 201}, {380, 920}, {381, 875}, {382, 498}, {383, 124}, {384, 720}, {385, 731}, {386, 938}, {387, 956}, {388, 844}, {389, 837}, {390, 976}, {391, 27}, {392, 135}, {393, 944}, {394, 61}, {395, 905}, {396, 491}, {397, 833}, {398, 381}, {399, 382}, {400, 800}, {401, 743}, {402, 179}, {403, 619}, {404, 575}, {405, 879}, {406, 28}, {407, 879}, {408, 123}, {409, 988}, {410, 792}, {411, 95}, {412, 558}, {413, 583}, {414, 329}, {415, 468}, {416, 354}, {417, 248}, {418, 743}, {419, 750}, {420, 291}, {421, 74}, {422, 815}, {423, 532}, {424, 738}, {425, 349}, {426, 141}, {427, 756}, {428, 242}, {429, 844}, {430, 420}, {431, 892}, {432, 257}, {433, 852}, {434, 318}, {435, 420}, {436, 184}, {437, 102}, {438, 402}, {439, 729}, {440, 857}, {441, 702}, {442, 645}, {443, 677}, {444, 167}, {445, 84}, {446, 1}, {447, 604}, {448, 89}, {449, 542}, {450, 350}, {451, 288}, {452, 417}, {453, 251}, {454, 387}, {455, 965}, {456, 485}, {457, 34}, {458, 463}, {459, 256}, {460, 45}, {461, 276}, {462, 713}, {463, 452}, {464, 733}, {465, 685}, {466, 983}, {467, 80}, {468, 413}, {469, 533}, {470, 939}, {471, 305}, {472, 99}, {473, 20}, {474, 851}, {475, 956}, {476, 19}, {477, 286}, {478, 778}, {479, 355}, {480, 451}, {481, 877}, {482, 686}, {483, 155}, {484, 239}, {485, 219}, {486, 772}, {487, 12}, {488, 531}, {489, 37}, {490, 86}, {491, 130}, {492, 485}, {493, 492}, {494, 910}, {495, 79}, {496, 305}, {497, 451}, {498, 283}, {499, 521}, {500, 772}, {501, 505}, {502, 240}, {503, 444}, {504, 154}, {505, 630}, {506, 176}, {507, 226}, {508, 29}, {509, 223}, {510, 839}, {511, 265}, {512, 681}, {513, 143}, {514, 821}, {515, 716}, {516, 908}, {517, 677}, {518, 938}, {519, 396}, {520, 922}, {521, 44}, {522, 535}, {523, 120}, {524, 968}, {525, 697}, {526, 987}, {527, 511}, {528, 541}, {529, 92}, {530, 488}, {531, 589}, {532, 782}, {533, 674}, {534, 440}, {535, 938}, {536, 88}, {537, 106}, {538, 385}, {539, 48}, {540, 255}, {541, 535}, {542, 776}, {543, 203}, {544, 221}, {545, 5}, {546, 729}, {547, 168}, {548, 746}, {549, 110}, {550, 953}, {551, 238}, {552, 707}, {553, 749}, {554, 936}, {555, 829}, {556, 865}, {557, 565}, {558, 626}, {559, 479}, {560, 829}, {561, 673}, {562, 263}, {563, 702}, {564, 753}, {565, 985}, {566, 597}, {567, 34}, {568, 12}, {569, 812}, {570, 885}, {571, 517}, {572, 71}, {573, 856}, {574, 792}, {575, 750}, {576, 162}, {577, 559}, {578, 75}, {579, 380}, {580, 161}, {581, 988}, {582, 458}, {583, 808}, {584, 604}, {585, 931}, {586, 146}, {587, 584}, {588, 530}, {589, 260}, {590, 31}, {591, 860}, {592, 63}, {593, 211}, {594, 669}, {595, 794}, {596, 799}, {597, 354}, {598, 712}, {599, 265}, {600, 615}, {601, 963}, {602, 651}, {603, 900}, {604, 350}, {605, 196}, {606, 402}, {607, 403}, {608, 283}, {609, 528}, {610, 798}, {611, 877}, {612, 525}, {613, 962}, {614, 709}, {615, 393}, {616, 742}, {617, 537}, {618, 47}, {619, 987}, {620, 199}, {621, 287}, {622, 634}, {623, 138}, {624, 256}, {625, 554}, {626, 653}, {627, 493}, {628, 711}, {629, 682}, {630, 269}, {631, 650}, {632, 448}, {633, 222}, {634, 568}, {635, 730}, {636, 19}, {637, 927}, {638, 688}, {639, 27}, {640, 49}, {641, 953}, {642, 283}, {643, 848}, {644, 793}, {645, 664}, {646, 462}, {647, 335}, {648, 800}, {649, 648}, {650, 899}, {651, 60}, {652, 585}, {653, 951}, {654, 406}, {655, 471}, {656, 586}, {657, 253}, {658, 199}, {659, 777}, {660, 309}, {661, 618}, {662, 810}, {663, 625}, {664, 858}, {665, 448}, {666, 36}, {667, 888}, {668, 99}, {669, 185}, {670, 290}, {671, 434}, {672, 596}, {673, 255}, {674, 295}, {675, 999}, {676, 164}, {677, 922}, {678, 477}, {679, 624}, {680, 722}, {681, 189}, {682, 92}, {683, 8}, {684, 73}, {685, 613}, {686, 855}, {687, 32}, {688, 755}, {689, 756}, {690, 68}, {691, 34}, {692, 343}, {693, 727}, {694, 414}, {695, 507}, {696, 646}, {697, 943}, {698, 770}, {699, 932}, {700, 773}, {701, 869}, {702, 555}, {703, 80}, {704, 633}, {705, 688}, {706, 123}, {707, 230}, {708, 682}, {709, 864}, {710, 348}, {711, 615}, {712, 634}, {713, 197}, {714, 701}, {715, 162}, {716, 880}, {717, 154}, {718, 804}, {719, 134}, {720, 249}, {721, 401}, {722, 768}, {723, 34}, {724, 264}, {725, 595}, {726, 645}, {727, 745}, {728, 471}, {729, 351}, {730, 547}, {731, 262}, {732, 561}, {733, 463}, {734, 592}, {735, 304}, {736, 500}, {737, 389}, {738, 381}, {739, 91}, {740, 539}, {741, 57}, {742, 778}, {743, 488}, {744, 323}, {745, 34}, {746, 168}, {747, 861}, {748, 415}, {749, 691}, {750, 49}, {751, 590}, {752, 341}, {753, 432}, {754, 21}, {755, 23}, {756, 891}, {757, 980}, {758, 844}, {759, 107}, {760, 27}, {761, 478}, {762, 383}, {763, 173}, {764, 920}, {765, 418}, {766, 307}, {767, 233}, {768, 654}, {769, 671}, {770, 120}, {771, 540}, {772, 810}, {773, 531}, {774, 806}, {775, 615}, {776, 824}, {777, 689}, {778, 589}, {779, 510}, {780, 686}, {781, 962}, {782, 311}, {783, 303}, {784, 102}, {785, 627}, {786, 677}, {787, 116}, {788, 12}, {789, 371}, {790, 673}, {791, 674}, {792, 780}, {793, 761}, {794, 119}, {795, 670}, {796, 266}, {797, 140}, {798, 242}, {799, 890}, {800, 142}, {801, 827}, {802, 140}, {803, 331}, {804, 154}, {805, 558}, {806, 48}, {807, 126}, {808, 18}, {809, 187}, {810, 287}, {811, 368}, {812, 258}, {813, 883}, {814, 481}, {815, 568}, {816, 500}, {817, 295}, {818, 103}, {819, 233}, {820, 628}, {821, 317}, {822, 244}, {823, 723}, {824, 684}, {825, 847}, {826, 82}, {827, 663}, {828, 108}, {829, 691}, {830, 640}, {831, 567}, {832, 934}, {833, 265}, {834, 938}, {835, 709}, {836, 939}, {837, 232}, {838, 958}, {839, 465}, {840, 708}, {841, 36}, {842, 768}, {843, 745}, {844, 899}, {845, 839}, {846, 632}, {847, 20}, {848, 582}, {849, 374}, {850, 755}, {851, 975}, {852, 935}, {853, 335}, {854, 710}, {855, 318}, {856, 331}, {857, 402}, {858, 741}, {859, 481}, {860, 473}, {861, 782}, {862, 936}, {863, 183}, {864, 263}, {865, 177}, {866, 395}, {867, 534}, {868, 729}, {869, 176}, {870, 989}, {871, 670}, {872, 17}, {873, 697}, {874, 205}, {875, 77}, {876, 783}, {877, 18}, {878, 32}, {879, 480}, {880, 117}, {881, 679}, {882, 220}, {883, 790}, {884, 146}, {885, 517}, {886, 526}, {887, 555}, {888, 925}, {889, 278}, {890, 329}, {891, 973}, {892, 678}, {893, 488}, {894, 653}, {895, 789}, {896, 713}, {897, 303}, {898, 506}, {899, 205}, {900, 684}, {901, 467}, {902, 956}, {903, 637}, {904, 929}, {905, 241}, {906, 926}, {907, 964}, {908, 257}, {909, 685}, {910, 708}, {911, 254}, {912, 846}, {913, 171}, {914, 960}, {915, 25}, {916, 159}, {917, 116}, {918, 527}, {919, 401}, {920, 789}, {921, 388}, {922, 920}, {923, 122}, {924, 756}, {925, 608}, {926, 308}, {927, 56}, {928, 818}, {929, 924}, {930, 224}, {931, 214}, {932, 76}, {933, 575}, {934, 872}, {935, 111}, {936, 431}, {937, 759}, {938, 444}, {939, 946}, {940, 904}, {941, 22}, {942, 350}, {943, 587}, {944, 298}, {945, 797}, {946, 789}, {947, 239}, {948, 385}, {949, 38}, {950, 79}, {951, 24}, {952, 712}, {953, 311}, {954, 424}, {955, 507}, {956, 843}, {957, 307}, {958, 838}, {959, 163}, {960, 559}, {961, 914}, {962, 249}, {963, 369}, {964, 650}, {965, 900}, {966, 688}, {967, 611}, {968, 498}, {969, 64}, {970, 24}, {971, 978}, {972, 761}, {973, 399}, {974, 823}, {975, 481}, {976, 815}, {977, 885}, {978, 862}, {979, 798}, {980, 499}, {981, 32}, {982, 480}, {983, 428}, {984, 551}, {985, 248}, {986, 769}, {987, 584}, {988, 276}, {989, 839}, {990, 330}, {991, 314}, {992, 319}, {993, 20}, {994, 179}, {995, 637}, {996, 514}, {997, 877}, {998, 823}, {999, 551}};

int numero = 666;
int max = 1000;

struct read_format {
  uint64_t nr;
  struct {
    uint64_t value;
    uint64_t id;
  } values[];
};

int binary_search (int x, int max);


// function to save data in saida_bsearch.csv
void save_data(uint64_t val_cycles, uint64_t val_instruction){

	FILE *arq;

	arq = fopen("saida_bsearch.csv", "a");

	if(arq == NULL){
		printf("ERROR OPEN FILE");
	}

	fprintf(arq, "%"PRIu64";%"PRIu64" \n", val_cycles,val_instruction);
	fclose(arq);


}

int binary_search (int x, int max)
{
  int fvalue, mid, up, low ;

  low = 0;
  up = max;
  fvalue = -1 /* all data are positive */ ;
  while (low <= up) {
    mid = (low + up) >> 1;
    if ( data[mid].key == x ) {  /*  found  */
      up = low - 1;
      fvalue = data[mid].value;
//	#ifdef DEBUG
//	printf("FOUND!!\n");
//	#endif
    }
    else  /* not found */
      if ( data[mid].key > x ) 	{
	up = mid - 1;
//	#ifdef DEBUG
//	printf("MID-1\n");
//	#endif
      }
      else   {
             	low = mid + 1;
//	#ifdef DEBUG
//	printf("MID+1\n");
//	#endif
		  }
//	#ifdef DEBUG
//		cnt1++;
//	#endif
	  }
//	#ifdef DEBUG
//	printf("Loop Count : %d value= %d   \n  ", cnt1, fvalue);
//	#endif
	  return fvalue;
}

int main(int argc, char* argv[]) {

  struct perf_event_attr pea;
   int fd_cycles, fd_instruction;
   uint64_t id_cycles, id_instruction;
   uint64_t val_cycles, val_instruction;

  char buf[4096];
  struct read_format* rf = (struct read_format*) buf;
  int i;

  cpu_set_t set;

  CPU_ZERO(&set);
  CPU_SET(0,&set);
  sched_setaffinity(getpid(), sizeof(set), &set);

  // cycles
  memset(&pea, 0, sizeof(struct perf_event_attr));
  pea.type = PERF_TYPE_HARDWARE;
  pea.size = sizeof(struct perf_event_attr);
  pea.config = PERF_COUNT_HW_CPU_CYCLES;
  pea.disabled = 1;
  pea.exclude_kernel = 1;
  pea.exclude_hv = 1;
  pea.read_format = PERF_FORMAT_GROUP | PERF_FORMAT_ID;
  fd_cycles = syscall(__NR_perf_event_open, &pea, 0, -1, -1, 0);
  ioctl(fd_cycles, PERF_EVENT_IOC_ID, &id_cycles);

  // instruction
  memset(&pea, 0, sizeof(struct perf_event_attr));
  pea.type = PERF_TYPE_HARDWARE;
  pea.size = sizeof(struct perf_event_attr);
  pea.config = PERF_COUNT_HW_INSTRUCTIONS;
  pea.disabled = 1;
  pea.exclude_kernel = 1;
  pea.exclude_hv = 1;
  pea.read_format = PERF_FORMAT_GROUP | PERF_FORMAT_ID;
  fd_instruction = syscall(__NR_perf_event_open, &pea, 0, -1, fd_cycles, 0);
  ioctl(fd_instruction, PERF_EVENT_IOC_ID, &id_instruction);

//  int max = 1000;

  // #ifdef WORSTCASE
	// 	int numero = max + 1;
	// #else
  //   // time(0) garante que o sorteio retorna sempre o mesmo valor
	// 	srand(time(0));
	// 	int numero = rand() % 999;
	// #endif

  //execution
  ioctl(fd_cycles, PERF_EVENT_IOC_RESET, PERF_IOC_FLAG_GROUP);
  ioctl(fd_cycles, PERF_EVENT_IOC_ENABLE, PERF_IOC_FLAG_GROUP);

  binary_search(numero, max);

  ioctl(fd_cycles, PERF_EVENT_IOC_DISABLE, PERF_IOC_FLAG_GROUP);

  read(fd_cycles, buf, sizeof(buf));
  for (i = 0; i < rf->nr; i++) {
    if (rf->values[i].id == id_cycles) {
      val_cycles = rf->values[i].value;
    } else if (rf->values[i].id == id_instruction) {
      val_instruction = rf->values[i].value;
    } 
  }

   save_data(val_cycles, val_instruction);

    /*printf("CYCLES: %"PRIu64"\n",val_cycles);
    printf("INSTRUCTION: %"PRIu64"\n",val_instruction);
    printf("CACHE BRANCH MISS: %"PRIu64"\n",val_ev1);
    printf("CACHE L1D MISS: %"PRIu64"\n",val_ev2);
    printf("CACHE MEMO ACCESS: %"PRIu64"\n",val_ev3);
    printf("CACHE L1I MISS: %"PRIu64"\n",val_ev4);
    printf("CACHE LL MISS: %"PRIu64"\n",val_ev5);*/

  close(fd_cycles);
  close(fd_instruction);
}